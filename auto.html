<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger â€” Auto Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background: #050710; color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
    }
    .wrap { max-width: 960px; margin: 0 auto; }
    h1 { margin: 0 0 4px; font-size: 22px; letter-spacing: .05em; }
    .subtitle { margin: 0; font-size: 13px; opacity: .78; }
    main { padding: 16px 20px 32px; }
    section { margin-bottom: 20px; }
    label { font-size: 13px; display: block; margin-bottom: 4px; opacity: .9; }
    input[type="text"] {
      width: 100%; padding: 7px 9px;
      border-radius: 6px; background: rgba(5,7,16,.9);
      border: 1px solid rgba(255,255,255,.2);
      font-size: 13px; color: #f5f5f5;
    }
    button {
      margin-top: 10px; padding: 7px 14px;
      border-radius: 999px; background: #75bcff;
      border: none; font-weight: 600; cursor: pointer;
      color: #050710; font-size: 13px;
    }
    .status-box {
      margin-top: 14px; padding: 12px 14px;
      border-radius: 8px; background: rgba(15,20,40,.9);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 12px; line-height: 1.7; white-space: pre-wrap;
      min-height: 60px;
    }
    .status-line { display:flex; gap:8px; margin-bottom:4px; }
    .status-line span.icon { width:1.2em; text-align:center; }
    .status-ok { color:#9be28f; }
    .status-warn { color:#ffd166; }
    .status-error { color:#ff6b6b; }
    .summary-ok,.summary-warn,.summary-error {
      margin-top:10px; padding:10px 12px; border-radius:8px;
      font-size:12px;
    }
    .summary-ok { background:rgba(23,80,43,.9); border:1px solid rgba(155,226,143,.8); }
    .summary-warn { background:rgba(80,65,23,.9); border:1px solid rgba(255,209,102,.9); }
    .summary-error { background:rgba(80,29,28,.9); border:1px solid rgba(255,107,107,.9); }
    footer {
      border-top:1px solid rgba(255,255,255,0.08);
      padding:10px 20px 18px; font-size:11px; opacity:.6;
    }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <h1>Sky Logger â€” Auto Verification</h1>
    <p class="subtitle">
      Firestore å…¬é–‹ãƒ­ã‚° ã¨ GitHub ãƒãƒƒã‚·ãƒ¥ã‚’ç…§åˆã—ã€ãƒ­ã‚°æ”¹ã–ã‚“ã®æœ‰ç„¡ã‚’è‡ªå‹•æ¤œè¨¼ã—ã¾ã™ã€‚
    </p>
  </div>
</header>

<main>
  <div class="wrap">
    <section>
      <label for="idInput">videoId / logId</label>
      <input id="idInput" type="text" placeholder="ä¾‹: e53434bf-8537-48f2-b32d-af99edff9aec" />
      <button id="runBtn">ã“ã® ID ã§æ¤œè¨¼ã™ã‚‹</button>
      <p style="font-size:11px;opacity:.7;margin-top:6px;">
        URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?videoId=</code> ã¾ãŸã¯ <code>?logId=</code> ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•ã§æ¤œè¨¼ã—ã¾ã™ã€‚
      </p>
    </section>

    <section>
      <div id="summary"></div>
      <div id="status" class="status-box">ã¾ã æ¤œè¨¼ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ Sky Logger æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
  </div>
</footer>

<script>
  const FB_PROJECT_ID = "sky-logger-appv1";
  const API_KEY = "AIzaSyA9mECKLUUpyaLsVLZJjq7KeZOEVzA";
  const COLLECTION = "public_logs";
  const GH_BASE = "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/";

  const statusEl = document.getElementById("status");
  const summaryEl = document.getElementById("summary");

  function resetStatus() { statusEl.innerHTML = ""; }
  function append(icon, text, cls="") {
    statusEl.innerHTML += `<div class="status-line ${cls}">
      <span class="icon">${icon}</span><span>${text}</span></div>`;
  }
  function setSummary(type, text) {
    summaryEl.innerHTML =
      `<div class="summary-${type}">${text}</div>`;
  }

  function params() {
    const p = new URLSearchParams(location.search);
    return {
      videoId: p.get("videoId")?.trim() || "",
      logId: p.get("logId")?.trim() || ""
    };
  }

  async function fetchFS(id) {
    const url = `https://firestore.googleapis.com/v1/projects/${FB_PROJECT_ID}/databases/(default)/documents/${COLLECTION}/${id}?key=${API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("Firestore error " + res.status);
    return await res.json();
  }

  function extract(doc) {
    const f = doc.fields;
    const val = (x)=> x?.stringValue ?? x?.integerValue ?? x?.doubleValue ?? null;
    return {
      id: val(f.id),
      videoId: val(f.videoId),
      hash: val(f.hash),
      githubPath: val(f.githubPath),
    };
  }

  async function fetchGH(path) {
    const url = GH_BASE + path;
    const res = await fetch(url);
    if (!res.ok) throw new Error("GitHub hash error " + res.status);
    return (await res.text()).trim();
  }

  async function verify() {
    resetStatus();
    const p = params();
    const effectiveId =
      document.getElementById("idInput").value.trim() ||
      p.videoId || p.logId;

    if (!effectiveId) { alert("ID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    document.getElementById("idInput").value = effectiveId;
    append("ğŸ”", `ID: ${effectiveId}`, "status-warn");

    try {
      append("â³", "Firestore ã‚’å–å¾—ä¸­â€¦");
      const doc = await fetchFS(effectiveId);
      const log = extract(doc);
      append("ğŸ“„", "Firestore ãƒ­ã‚°å–å¾—å®Œäº†", "status-ok");

      append("ğŸ§©", `hash(Firestore): ${log.hash}`, "status-ok");
      append("â³", "GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—ä¸­â€¦");

      const gh = await fetchGH(log.githubPath);
      append("ğŸ”‘", `hash(GitHub): ${gh}`, "status-ok");

      if (log.hash === gh) {
        append("âœ…", "ğŸ”¥ Firestore ã¨ GitHub ã® hash ãŒå®Œå…¨ä¸€è‡´", "status-ok");
        setSummary("ok", "ã“ã®ãƒ­ã‚°ã¯æ”¹ã–ã‚“ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      } else {
        append("âŒ", "Firestore ã¨ GitHub ã® hash ãŒä¸€è‡´ã—ã¾ã›ã‚“", "status-error");
        setSummary("error", "âš ï¸ æ”¹ã–ã‚“ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
      }

    } catch (e) {
      append("âŒ", "ã‚¨ãƒ©ãƒ¼: " + e.message, "status-error");
      setSummary("error", "æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  }

  document.getElementById("runBtn").onclick = verify;
  window.onload = () => {
    const p = params();
    if (p.videoId || p.logId) verify();
  };
</script>
</body>
</html>
