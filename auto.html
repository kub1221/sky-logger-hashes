<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger Auto Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #050710;
      color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.05em;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      opacity: 0.75;
    }
    main {
      padding: 16px 20px 32px;
    }
    section {
      margin-bottom: 20px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(5, 7, 16, 0.9);
      color: #f5f5f5;
      font-size: 13px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #75bcff;
      box-shadow: 0 0 0 1px rgba(117, 188, 255, 0.5);
    }
    button {
      margin-top: 10px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #75bcff;
      color: #050710;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(15, 20, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .status-line {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .status-line span.icon {
      font-size: 14px;
      width: 1.2em;
      text-align: center;
    }
    .status-line span.text {
      flex: 1;
    }
    .status-ok {
      color: #9be28f;
    }
    .status-warn {
      color: #ffd166;
    }
    .status-error {
      color: #ff6b6b;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.05);
      padding: 1px 4px;
      border-radius: 4px;
    }
    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 20px 16px;
      font-size: 11px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sky Logger â€” Auto Verification</h1>
    <p class="subtitle">
      Firestore ã®ãƒ­ã‚°JSONã¨ GitHub Hash Archive ã® SHA-256 ã‚’è‡ªå‹•ç…§åˆã—ã¦ã€
      ã€Œæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚’æ¤œè¨¼ã™ã‚‹ãƒšãƒ¼ã‚¸ã€‚
    </p>
  </div>
</header>

<main>
  <div class="wrap">
    <section>
      <label for="logId">logIdï¼ˆFirestore / GitHub å…±é€šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰</label>
      <input id="logId" type="text" placeholder="ä¾‹: 7df5f3fb-1c77-4db4-9c42-ac462424a87e" />
      <button id="runBtn">ã“ã® logId ã§è‡ªå‹•æ¤œè¨¼ã‚’å®Ÿè¡Œ</button>
      <p style="font-size:11px;opacity:.7;margin-top:6px;">
        URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?logId=...</code> ã§ã‚‚æŒ‡å®šã§ãã¾ã™ã€‚
      </p>
    </section>

    <section>
      <div id="status" class="status-box">
        ã¾ã æ¤œè¨¼ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ Sky Logger ã‚·ã‚¹ãƒ†ãƒ ã®å†…éƒ¨æ¤œè¨¼ç”¨ã§ã™ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å…¬é–‹ã—ãªã„ï¼‰ã€‚<br />
  </div>
</footer>

<script>
  // ================================
  // ğŸ”§ è¨­å®šï¼ˆã‚ãªãŸå°‚ç”¨ã«æ›¸ãæ›ãˆæ¸ˆã¿ï¼‰
  // ================================

  // Firestore ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  const FIREBASE_PROJECT_ID = "sky-logger-appv1";

  // Web API ã‚­ãƒ¼
  const FIRESTORE_API_KEY   = "AIzaSyA9mECKLUUpyaLsVLZJjq7KeZOEVzA";

  // ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç…§åˆã™ã‚‹ã‹ï¼ˆpublic_logsï¼‰
  const COLLECTION_PATH     = "public_logs";

  // GitHub Hash Archive
  const GITHUB_HASH_BASE =
    "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/hashes";

  const statusEl = document.getElementById("status");
  const logIdInput = document.getElementById("logId");
  const runBtn = document.getElementById("runBtn");

  function appendStatus(icon, text, cssClass) {
    const line = document.createElement("div");
    line.className = "status-line " + (cssClass || "");
    line.innerHTML = `<span class="icon">${icon}</span><span class="text">${text}</span>`;
    statusEl.appendChild(line);
  }

  function resetStatus(initialText) {
    statusEl.textContent = initialText || "";
  }

  function getLogIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const id = params.get("logId");
    return id ? id.trim() : null;
  }

  // ================================
  // Firestore ã‹ã‚‰1ä»¶å–å¾—
  // ================================
  async function fetchFirestoreDoc(logId) {
    const url =
      `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}` +
      `/databases/(default)/documents/${COLLECTION_PATH}/${logId}?key=${FIRESTORE_API_KEY}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error("Firestore ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—: " + res.status);
    return await res.json();
  }

  // Firestore â†’ ãƒãƒƒã‚·ãƒ¥å¯¾è±¡ã®JSONã«æ•´å½¢
  function extractFieldsFromFirestoreDoc(doc) {
    const f = doc.fields;
    const v = (x) =>
      x?.stringValue ??
      x?.integerValue ??
      x?.doubleValue ??
      x?.booleanValue ??
      x?.timestampValue ??
      null;

    return {
      uuid: v(f.uuid),
      videoId: v(f.videoId),
      finalFileName: v(f.finalFileName),
      lat: v(f.lat),
      lng: v(f.lng),
      capturedAt: v(f.capturedAt),
    };
  }

  // JSONã‚’ã‚­ãƒ¼é †ã§æ•´å½¢
  function canonicalJson(obj) {
    const sortObject = (o) => {
      if (o === null || typeof o !== "object") return o;
      if (Array.isArray(o)) return o.map(sortObject);
      return Object.fromEntries(
        Object.keys(o)
          .sort()
          .map((k) => [k, sortObject(o[k])])
      );
    };
    return JSON.stringify(sortObject(obj));
  }

  // SHA-256
  async function sha256Hex(str) {
    const buf = await crypto.subtle.digest(
      "SHA-256",
      new TextEncoder().encode(str)
    );
    return Array.from(new Uint8Array(buf))
      .map((b) => b.toString(16).padStart(2, "0"))
      .join("");
  }

  // GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—
  async function fetchGitHubHash(logId) {
    const url = `${GITHUB_HASH_BASE}/${logId}.txt`;
    const res = await fetch(url);
    if (!res.ok) throw new Error("GitHub ã®ãƒãƒƒã‚·ãƒ¥å–å¾—å¤±æ•—: " + res.status);
    return (await res.text()).trim();
  }

  // ================================
  // ãƒ¡ã‚¤ãƒ³
  // ================================
  async function runVerification() {
    const logId = logIdInput.value.trim();
    if (!logId) return alert("logId ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    resetStatus(`æ¤œè¨¼ä¸­...\nlogId: ${logId}\n`);

    try {
      appendStatus("â³", "Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—ä¸­â€¦");
      const doc = await fetchFirestoreDoc(logId);
      appendStatus("ğŸ“„", "Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—æˆåŠŸ", "status-ok");

      const obj = extractFieldsFromFirestoreDoc(doc);
      appendStatus("ğŸ§©", "ãƒãƒƒã‚·ãƒ¥å¯¾è±¡JSONæŠ½å‡º");

      const canon = canonicalJson(obj);
      appendStatus("ğŸ”§", "JSONæ­£è¦åŒ–å®Œäº†");

      appendStatus("â³", "SHA-256 è¨ˆç®—ä¸­â€¦");
      const localHash = await sha256Hex(canon);
      appendStatus("ğŸ”", `ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚·ãƒ¥: ${localHash}`, "status-ok");

      appendStatus("â³", "GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—ä¸­â€¦");
      const remoteHash = await fetchGitHubHash(logId);
      appendStatus("ğŸ”‘", `GitHubãƒãƒƒã‚·ãƒ¥: ${remoteHash}`, "status-ok");

      if (localHash === remoteHash) {
        appendStatus(
          "ğŸŸ¢",
          "å®Œå…¨ä¸€è‡´ â€” æ”¹ã–ã‚“ãªã—ï¼ˆã‚ªãƒªã‚¸ãƒŠãƒ«ã¨åŒä¸€ï¼‰",
          "status-ok"
        );
      } else {
        appendStatus(
          "ğŸ”´",
          "ä¸ä¸€è‡´ â€” Firestore ã¾ãŸã¯ GitHub ã®ã©ã“ã‹ãŒæ›¸ãæ›ãˆã‚‰ã‚ŒãŸå¯èƒ½æ€§ã‚ã‚Š",
          "status-error"
        );
      }
    } catch (e) {
      appendStatus("âŒ", "ã‚¨ãƒ©ãƒ¼: " + e.message, "status-error");
    }
  }

  runBtn.addEventListener("click", runVerification);

  window.addEventListener("DOMContentLoaded", () => {
    const id = getLogIdFromUrl();
    if (id) {
      logIdInput.value = id;
      runVerification();
    }
  });
</script>
</body>
</html>
