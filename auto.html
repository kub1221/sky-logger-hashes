<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger Auto Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 0;
      background: #050710;
      color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      opacity: 0.7;
    }
    main {
      padding: 16px 20px 32px;
    }
    label {
      font-size: 13px;
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(5,7,16,0.9);
      color: #fff;
      margin-bottom: 10px;
    }
    button {
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #75bcff;
      color: #050710;
      font-weight: 600;
    }
    .status-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(20, 28, 48, 0.9);
      font-size: 12px;
      white-space: pre-wrap;
    }
    .status-line {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    .status-ok { color: #9be28f; }
    .status-error { color: #ff6b6b; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sky Logger ‚Äî Auto Verification</h1>
    <p class="subtitle">Firestore ÂÖ¨Èñã„É≠„Ç∞„Å® GitHub „Éè„ÉÉ„Ç∑„É•„ÅÆÂÆåÂÖ®‰∏ÄËá¥„ÇíÊ§úË®º</p>
  </div>
</header>

<main>
  <div class="wrap">
    <label for="videoId">videoIdÔºà„Åæ„Åü„ÅØ logIdÔºâ</label>
    <input id="videoId" type="text" placeholder="‰æã: d2914b52-ef7b-42cc-9bcc-cb9447f02205" />
    <button id="runBtn">Ê§úË®º„Åô„Çã</button>

    <div id="status" class="status-box">„Åæ„Å†Ê§úË®º„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</div>
  </div>
</main>

<script>
  // ========= Ë®≠ÂÆö =========
  const PROJECT_ID = "sky-logger-appv1";
  const API_KEY = "AIzaSyA9mECKLUUpyaLsVLZJjq7KeZOEVzA";
  const COLLECTION = "public_logs";
  const GITHUB_BASE =
    "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main";

  const statusEl = document.getElementById("status");
  const input = document.getElementById("videoId");

  function append(icon, text, cls="") {
    const div = document.createElement("div");
    div.className = "status-line " + cls;
    div.innerHTML = `<span>${icon}</span> <span>${text}</span>`;
    statusEl.appendChild(div);
  }
  function reset(text="") {
    statusEl.innerHTML = text;
  }
  function fromUrl() {
    const p = new URLSearchParams(location.search);
    return p.get("videoId") || p.get("logId");
  }

  // ========= Firestore public_logs „ÇíÂèñÂæó =========
  async function fetchFirestore(videoId) {
    const url =
      `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}` +
      `/databases/(default)/documents/${COLLECTION}/${videoId}` +
      `?key=${API_KEY}`;

    const r = await fetch(url);
    if (!r.ok) throw new Error("Firestore ÂèñÂæóÂ§±Êïó: " + r.status);
    return await r.json();
  }

  function parseFirestore(doc) {
    const f = doc.fields;
    const v = (x) =>
      x?.stringValue ??
      x?.timestampValue ??
      x?.booleanValue ??
      x?.integerValue ??
      x?.doubleValue ??
      null;

    return {
      id: doc.name.split("/").pop(),
      videoId: v(f.videoId),
      hash: v(f.hash),
      githubPath: v(f.githubPath)
    };
  }

  // ========= GitHub „ÅÆ hash „ÇíÂèñÂæó =========
  async function fetchGithubHash(githubPath, videoId) {
    const path = githubPath ?? `hashes/${videoId}.txt`;
    const url = `${GITHUB_BASE}/${path}`;
    const r = await fetch(url);
    if (!r.ok) throw new Error("GitHub ÂèñÂæóÂ§±Êïó: " + r.status);
    return (await r.text()).trim().split("\n")[0]; // 1Ë°åÁõÆ„ÅÆ„Åø
  }

  // ========= „É°„Ç§„É≥ =========
  async function run() {
    const videoId = input.value.trim();
    if (!videoId) return alert("videoId „ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

    reset("Ê§úË®º‰∏≠...\n");
    try {
      append("‚è≥", "Firestore public_logs „ÇíÂèñÂæó‰∏≠‚Ä¶");
      const doc = await fetchFirestore(videoId);
      append("üìÑ", "Firestore „Éâ„Ç≠„É•„É°„É≥„ÉàÂèñÂæóÊàêÂäü", "status-ok");

      const fb = parseFirestore(doc);
      append("‚ÑπÔ∏è", `hash(Firestore): ${fb.hash}`);

      append("‚è≥", "GitHub „Éè„ÉÉ„Ç∑„É•ÂèñÂæó‰∏≠‚Ä¶");
      const gh = await fetchGithubHash(fb.githubPath, fb.videoId);
      append("‚ÑπÔ∏è", `hash(GitHub): ${gh}`);

      if (fb.hash === gh) {
        append("üü¢", "ÂÆåÂÖ®‰∏ÄËá¥ ‚Äî Êîπ„Åñ„Çì„Å™„Åó", "status-ok");
      } else {
        append("üî¥", "‰∏ç‰∏ÄËá¥ ‚Äî Êîπ„Åñ„Çì„ÅÆÂèØËÉΩÊÄß„ÅÇ„Çä", "status-error");
      }

    } catch (e) {
      append("‚ùå", e.message, "status-error");
    }
  }

  document.getElementById("runBtn").onclick = run;

  window.onload = () => {
    const id = fromUrl();
    if (id) {
      input.value = id;
      run();
    }
  };
</script>
</body>
</html>
