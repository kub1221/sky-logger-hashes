<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger Auto Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #050710;
      color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.05em;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      opacity: 0.75;
    }
    main {
      padding: 16px 20px 32px;
    }
    section {
      margin-bottom: 20px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(5, 7, 16, 0.9);
      color: #f5f5f5;
      font-size: 13px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #75bcff;
      box-shadow: 0 0 0 1px rgba(117, 188, 255, 0.5);
    }
    button {
      margin-top: 10px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #75bcff;
      color: #050710;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(15, 20, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .status-line {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .status-line span.icon {
      font-size: 14px;
      width: 1.2em;
      text-align: center;
    }
    .status-line span.text {
      flex: 1;
    }
    .status-ok {
      color: #9be28f;
    }
    .status-warn {
      color: #ffd166;
    }
    .status-error {
      color: #ff6b6b;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.05);
      padding: 1px 4px;
      border-radius: 4px;
    }
    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 20px 16px;
      font-size: 11px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sky Logger â€” Auto Verification</h1>
    <p class="subtitle">
      Firestore ã®ãƒ­ã‚°JSONã¨ GitHub Hash Archive ã® SHA-256 ã‚’è‡ªå‹•ç…§åˆã—ã¦ã€
      ã€Œæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚’æ¤œè¨¼ã™ã‚‹ãƒšãƒ¼ã‚¸ã€‚
    </p>
  </div>
</header>

<main>
  <div class="wrap">
    <section>
      <label for="logId">logIdï¼ˆFirestore / GitHub å…±é€šã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼‰</label>
      <input id="logId" type="text" placeholder="ä¾‹: 7df5f3fb-1c77-4db4-9c42-ac462424a87e" />
      <button id="runBtn">ã“ã® logId ã§è‡ªå‹•æ¤œè¨¼ã‚’å®Ÿè¡Œ</button>
      <p style="font-size:11px;opacity:.7;margin-top:6px;">
        URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?logId=...</code> ã§ã‚‚æŒ‡å®šã§ãã¾ã™ã€‚
      </p>
    </section>

    <section>
      <div id="status" class="status-box">
        ã¾ã æ¤œè¨¼ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ Sky Logger ã‚·ã‚¹ãƒ†ãƒ ã®å†…éƒ¨æ¤œè¨¼ç”¨ã§ã™ï¼ˆä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å…¬é–‹ã—ãªã„ï¼‰ã€‚<br />
    å®Ÿéš›ã«ç½²åã«ä½¿ã† JSON ã®æ§‹æˆã‚„ã‚­ãƒ¼åã¯ã€ã‚¢ãƒ—ãƒªå´ã®å®Ÿè£…ã«åˆã‚ã›ã¦
    <code>extractFieldsFromFirestoreDoc()</code> å†…ã‚’èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
  </div>
</footer>

<script>
  // ================================
  // âœ… è¨­å®šï¼ˆã“ã“ã‚’ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦æ›¸ãæ›ãˆã‚‹ï¼‰
  // ================================

  // âœ… TODO: Firestore ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  const FIREBASE_PROJECT_ID = "YOUR_PROJECT_ID";

  // âœ… TODO: Web API ã‚­ãƒ¼ï¼ˆã™ã§ã« firestore_viewer.html ã§ä½¿ã£ã¦ã„ã‚‹ç‰©ã¨åŒã˜ï¼‰
  const FIRESTORE_API_KEY = "YOUR_FIRESTORE_API_KEY";

  // âœ… TODO: ã©ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã‚’æ¤œè¨¼ã™ã‚‹ã‹
  //   ä¾‹: "logs" ã¾ãŸã¯ "public_logs"
  const COLLECTION_PATH = "logs";

  // GitHub Hash Archive ã® raw ãƒ™ãƒ¼ã‚¹URLï¼ˆã‚ãªãŸã®ãƒªãƒã‚¸ãƒˆãƒªã«å›ºå®šï¼‰
  const GITHUB_HASH_BASE =
    "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/hashes";

  // ================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ================================

  const statusEl = document.getElementById("status");
  const logIdInput = document.getElementById("logId");
  const runBtn = document.getElementById("runBtn");

  function appendStatus(icon, text, cssClass) {
    const line = document.createElement("div");
    line.className = "status-line " + (cssClass || "");
    const iconSpan = document.createElement("span");
    iconSpan.className = "icon";
    iconSpan.textContent = icon;
    const textSpan = document.createElement("span");
    textSpan.className = "text";
    textSpan.textContent = text;
    line.appendChild(iconSpan);
    line.appendChild(textSpan);
    statusEl.appendChild(line);
  }

  function resetStatus(initialText) {
    statusEl.textContent = "";
    if (initialText) {
      const p = document.createElement("div");
      p.textContent = initialText;
      p.style.fontSize = "12px";
      statusEl.appendChild(p);
    }
  }

  function getLogIdFromUrl() {
    const search = new URLSearchParams(window.location.search);
    const id = search.get("logId");
    return id && id.trim().length > 0 ? id.trim() : null;
  }

  // ================================
  // Firestore ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—
  // ================================

  async function fetchFirestoreDoc(logId) {
    // Firestore REST API
    const url =
      "https://firestore.googleapis.com/v1/projects/" +
      encodeURIComponent(FIREBASE_PROJECT_ID) +
      "/databases/(default)/documents/" +
      encodeURIComponent(COLLECTION_PATH) +
      "/" +
      encodeURIComponent(logId) +
      "?key=" +
      encodeURIComponent(FIRESTORE_API_KEY);

    const res = await fetch(url);
    if (!res.ok) {
      throw new Error("Firestore ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status);
    }
    return await res.json();
  }

  // ================================
  // Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â†’ ãƒãƒƒã‚·ãƒ¥å¯¾è±¡JSONã¸å¤‰æ›
  // ================================
  // ã“ã“ãŒä¸€ç•ªã€Œã‚ãªãŸã®å®Ÿè£…ã«åˆã‚ã›ã¦èª¿æ•´ã™ã¹ãå ´æ‰€ã€ã§ã™ã€‚
  //
  // ç¾åœ¨ã®æƒ³å®šï¼š
  //   - Firestore ã® fields ã«
  //       uuid, videoId, finalFileName, lat, lng, capturedAt
  //     ãªã©ãŒå…¥ã£ã¦ãŠã‚Šã€ãã‚Œã‚’å…ƒã«ãƒãƒƒã‚·ãƒ¥ã‚’ä½œã£ã¦ã„ã‚‹ã€‚
  //
  // â€» å®Ÿéš›ã®ã‚­ãƒ¼åãŒé•ã†å ´åˆã¯ã€ã“ã“ã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚
  //
  function extractFieldsFromFirestoreDoc(doc) {
    if (!doc || !doc.fields) {
      throw new Error("Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå½¢å¼ãŒæƒ³å®šã¨é•ã„ã¾ã™ï¼ˆfields ãŒç„¡ã„ï¼‰");
    }
    const f = doc.fields;

    // Firestore ã® Value å‹ã‹ã‚‰ç´ ã®å€¤ã‚’å–ã‚Šå‡ºã™ãƒ˜ãƒ«ãƒ‘ãƒ¼
    const v = (field) => {
      if (!field) return null;
      if ("stringValue" in field) return field.stringValue;
      if ("integerValue" in field) return Number(field.integerValue);
      if ("doubleValue" in field) return Number(field.doubleValue);
      if ("booleanValue" in field) return !!field.booleanValue;
      if ("timestampValue" in field) return field.timestampValue;
      // å¿…è¦ã«å¿œã˜ã¦ä»–ã®å‹ã«ã‚‚å¯¾å¿œ
      return null;
    };

    // âœ… TODO: å®Ÿéš›ã«ãƒãƒƒã‚·ãƒ¥ã®è¨ˆç®—å¯¾è±¡ã«ã—ã¦ã„ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚’ã“ã“ã«ä¸¦ã¹ã‚‹
    const obj = {
      uuid: v(f.uuid),
      videoId: v(f.videoId),
      finalFileName: v(f.finalFileName),
      lat: v(f.lat),
      lng: v(f.lng),
      capturedAt: v(f.capturedAt), // UTC ISO æ–‡å­—åˆ—ãªã©
    };

    // ä¸è¦ãª undefined ã‚’å‰Šã‚‹
    Object.keys(obj).forEach((k) => {
      if (obj[k] === undefined || obj[k] === null) {
        delete obj[k];
      }
    });

    return obj;
  }

  // ================================
  // JSON ã‚’ã‚­ãƒ¼é †ã§æ­£è¦åŒ–ã—ã¦æ–‡å­—åˆ—åŒ–
  // ================================
  function canonicalJson(obj) {
    function sortObject(value) {
      if (value === null || typeof value !== "object") return value;
      if (Array.isArray(value)) return value.map(sortObject);
      const sortedKeys = Object.keys(value).sort();
      const result = {};
      for (const k of sortedKeys) {
        result[k] = sortObject(value[k]);
      }
      return result;
    }

    const sorted = sortObject(obj);
    // ã‚¹ãƒšãƒ¼ã‚¹ç„¡ã—ã® minify JSON
    return JSON.stringify(sorted);
  }

  // ================================
  // SHA-256ï¼ˆWeb Crypto APIï¼‰
  // ================================
  async function sha256Hex(str) {
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
  }

  // ================================
  // GitHub ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥å–å¾—
  // ================================
  async function fetchGitHubHash(logId) {
    const url = `${GITHUB_HASH_BASE}/${encodeURIComponent(logId)}.txt`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error("GitHub ã‹ã‚‰ã®ãƒãƒƒã‚·ãƒ¥å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: " + res.status);
    }
    const text = await res.text();
    // æ”¹è¡Œãªã©ã‚’é™¤å»ã—ã¦1è¡Œãƒãƒƒã‚·ãƒ¥ã«
    return text.trim();
  }

  // ================================
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  // ================================
  async function runVerification() {
    const logId = logIdInput.value.trim();
    if (!logId) {
      alert("logId ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    resetStatus("æ¤œè¨¼ã‚’é–‹å§‹ã—ã¾ã™â€¦");
    runBtn.disabled = true;

    try {
      appendStatus("ğŸ”¹", `logId: ${logId}`);

      // 1. Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—
      appendStatus("â³", "Firestore ã‹ã‚‰ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—ä¸­â€¦");
      const doc = await fetchFirestoreDoc(logId);
      appendStatus("âœ…", "Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—æˆåŠŸã€‚", "status-ok");

      // 2. ãƒãƒƒã‚·ãƒ¥å¯¾è±¡ã® JSON æŠ½å‡º
      const objForHash = extractFieldsFromFirestoreDoc(doc);
      appendStatus(
        "ğŸ“„",
        "ãƒãƒƒã‚·ãƒ¥å¯¾è±¡ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã—ãŸï¼ˆuuid / videoId / finalFileName ãªã©ï¼‰ã€‚"
      );

      // 3. ã‚­ãƒ¼é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ JSON æ–‡å­—åˆ—ã¸
      const canon = canonicalJson(objForHash);
      appendStatus("ğŸ§©", "ã‚­ãƒ¼é †ã§ã‚½ãƒ¼ãƒˆã—ãŸ JSON ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚");

      // 4. SHA-256 è¨ˆç®—
      appendStatus("â³", "SHA-256 ã‚’è¨ˆç®—ä¸­â€¦");
      const localHash = await sha256Hex(canon);
      appendStatus("ğŸ”", `ãƒ­ãƒ¼ã‚«ãƒ«ã§è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥: ${localHash}`, "status-ok");

      // 5. GitHub ã‹ã‚‰æ—¢å­˜ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
      appendStatus("â³", "GitHub Hash Archive ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—ä¸­â€¦");
      const remoteHash = await fetchGitHubHash(logId);
      appendStatus("ğŸ”‘", `GitHub ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒãƒƒã‚·ãƒ¥: ${remoteHash}`, "status-ok");

      // 6. æ¯”è¼ƒ
      if (localHash === remoteHash) {
        appendStatus(
          "ğŸŸ¢",
          "ãƒãƒƒã‚·ãƒ¥ãŒå®Œå…¨ä¸€è‡´ã—ã¾ã—ãŸã€‚ã“ã®ãƒ­ã‚°ã¯ GitHub ã«ä¿å­˜ã•ã‚ŒãŸå½“æ™‚ã‹ã‚‰æ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã¨åˆ¤æ–­ã§ãã¾ã™ã€‚",
          "status-ok"
        );
      } else {
        appendStatus(
          "ğŸ”´",
          "ãƒãƒƒã‚·ãƒ¥ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚Firestore ä¸Šã®ãƒ­ã‚°JSON ã¾ãŸã¯ GitHub ãƒãƒƒã‚·ãƒ¥ãŒã€ã©ã“ã‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚",
          "status-error"
        );
      }
    } catch (err) {
      console.error(err);
      appendStatus("âŒ", "æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message, "status-error");
    } finally {
      runBtn.disabled = false;
    }
  }

  // ================================
  // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
  // ================================
  runBtn.addEventListener("click", runVerification);

  // URL ã« logId ãŒä»˜ã„ã¦ã„ãŸã‚‰è‡ªå‹•å®Ÿè¡Œ
  window.addEventListener("DOMContentLoaded", () => {
    const logIdFromUrl = getLogIdFromUrl();
    if (logIdFromUrl) {
      logIdInput.value = logIdFromUrl;
      runVerification();
    }
  });
</script>
</body>
</html>
