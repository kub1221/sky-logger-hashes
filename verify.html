<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¸ Sky Logger Verify</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 40px 12px;
    }
    .card {
      background: #222;
      text-align: left;
      padding: 24px;
      border-radius: 12px;
      margin: 0 auto;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #7ec8ff;
      font-size: 22px;
      margin-bottom: 20px;
    }
    p { margin: 6px 0; line-height: 1.5; word-break: break-all; }
    span.key { color: #7ec8ff; font-weight: bold; }
    .map-button {
      display: block;
      background: #0078ff;
      color: white;
      padding: 10px 14px;
      margin: 18px auto 0;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      width: fit-content;
    }
    .time-block {
      background: #1b1b1b;
      padding: 10px 14px;
      border-radius: 8px;
      margin-top: 10px;
      line-height: 1.6;
    }
    .note {
      font-size: 12px;
      color: #999;
      margin-top: 10px;
      text-align: center;
    }
    hr {
      border: none;
      border-top: 1px solid #333;
      margin: 24px 0;
    }
    a.link-button, button.link-button {
      display: inline-block;
      background: #444;
      color: #fff;
      padding: 10px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s;
      margin: 4px 0;
      border: none;
      cursor: pointer;
    }
    a.link-button:hover, button.link-button:hover { background: #666; }
    .result { margin-top: 20px; color: #7ec8ff; font-weight: bold; text-align: center; }
  </style>
</head>
<body>
  <h1>ğŸ“¸ Sky Logger Verify</h1>
  <div class="card" id="content">èª­ã¿è¾¼ã¿ä¸­...</div>

  <hr>

  <div id="verifyButtons" style="display:none;">
    <button id="globalVerify" class="link-button">ğŸ“ å…¨ä½“ç…§åˆãƒ¢ãƒ¼ãƒ‰</button>
    <button id="singleVerify" class="link-button" style="background:#0078ff;">ğŸ’ å€‹åˆ¥ç…§åˆãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <div id="verifyResult" class="result"></div>

  <a href="https://kub1221.github.io/sky-logger-hashes/"
     target="_blank"
     class="link-button"
     style="background:#005fa3;">
    ğŸ“˜ Sky Logger æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®ä»•çµ„ã¿ã‚’èª­ã‚€
  </a>

  <script>
    // --- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— ---
    const params = new URLSearchParams(decodeURIComponent(window.location.search));
    const data = {
      uuid: params.get("uuid"),
      lat: params.get("lat"),
      lng: params.get("lng"),
      capturedAt: params.get("capturedAt"),
      file: params.get("file"),
      hash: params.get("hash")
    };

    // --- JSTå¤‰æ›é–¢æ•° ---
    function toJST(utcString) {
      if (!utcString) return "(æœªæŒ‡å®š)";
      try {
        const date = new Date(utcString);
        const p = n => String(n).padStart(2, "0");
        return `${date.getFullYear()}-${p(date.getMonth()+1)}-${p(date.getDate())} `
             + `${p(date.getHours())}:${p(date.getMinutes())}:${p(date.getSeconds())} (JST)`;
      } catch { return "(å¤‰æ›ã‚¨ãƒ©ãƒ¼)"; }
    }

    // --- åŸºæœ¬è¡¨ç¤º ---
    const content = document.getElementById("content");
    if (!data.uuid) {
      content.innerHTML = `<p>âŒ ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</p>`;
    } else {
      const jstTime = toJST(data.capturedAt);
      content.innerHTML = `
        <p><span class="key">UUID:</span> ${data.uuid}</p>
        <p><span class="key">ä½ç½®æƒ…å ±:</span> ${data.lat}, ${data.lng}</p>

        <div class="time-block">
          <p><span class="key">æ’®å½±æ—¥æ™‚ (UTC):</span><br>${data.capturedAt || "(æœªæŒ‡å®š)"}</p>
          <p><span class="key">æ’®å½±æ—¥æ™‚ (æ—¥æœ¬æ™‚é–“):</span><br>${jstTime}</p>
        </div>

        <p><span class="key">ãƒ•ã‚¡ã‚¤ãƒ«å:</span><br>${data.file || "(ä¸æ˜)"}</p>
        <p><span class="key">ãƒãƒƒã‚·ãƒ¥:</span><br>${data.hash || "(ä¸æ˜)"}</p>

        <a class="map-button" target="_blank"
           href="https://www.google.com/maps?q=${data.lat},${data.lng}">
           ğŸŒ Googleãƒãƒƒãƒ—ã§é–‹ã
        </a>

        <div class="note">â€» UTCã¯å›½éš›æ¨™æº–æ™‚ã€JSTã¯æ—¥æœ¬æ™‚é–“ï¼ˆUTC+9ï¼‰ã§ã™ã€‚</div>
      `;
    }

    // --- ç…§åˆãƒœã‚¿ãƒ³è¡¨ç¤º ---
    if (data.hash) {
      document.getElementById("verifyButtons").style.display = "block";
    }

    const resultBox = document.getElementById("verifyResult");

    // --- ledger.jsonã‚’å–å¾—ï¼ˆãƒ«ãƒ¼ãƒˆç›´ä¸‹å¯¾å¿œï¼‰ ---
    async function fetchLedger() {
      const url = "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/ledger.json";
      const res = await fetch(url);
      if (!res.ok) throw new Error("ledger.json èª­ã¿è¾¼ã¿å¤±æ•—");
      return await res.json();
    }

    // ğŸ’ å€‹åˆ¥ç…§åˆãƒ¢ãƒ¼ãƒ‰ï¼ˆâœ…ä¸€è‡´ã—ãŸã‚‰è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
    document.getElementById("singleVerify").onclick = async () => {
      resultBox.textContent = "ç…§åˆä¸­...";
      try {
        const ledger = await fetchLedger();
        const found = ledger.logs.find(l => l.hash === data.hash);
        if (found) {
          resultBox.textContent = "âœ… ã“ã®ãƒ­ã‚°ã¯å…ƒå¸³ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ï¼ˆæ”¹ã–ã‚“ãªã—ï¼‰";

          // ğŸ”¹ videoIdæŠ½å‡ºï¼ˆUUIDã§ã‚‚çŸ­ç¸®ã§ã‚‚å¯¾å¿œï¼‰
          const m = data.file.match(/_([0-9a-f-]{7,36})\.json$/i);
          if (m) {
            const videoId = m[1];
            setTimeout(() => {
              window.location.href = `firestore_viewer.html?videoId=${encodeURIComponent(videoId)}`;
            }, 1500); // 1.5ç§’å¾Œã«è‡ªå‹•é·ç§»
          }

        } else {
          resultBox.textContent = "âš ï¸ ã“ã®ãƒ­ã‚°ã¯å…ƒå¸³ã«å­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆæœªç™»éŒ²ã¾ãŸã¯æ”¹ã–ã‚“ã®å¯èƒ½æ€§ï¼‰";
        }
      } catch (err) {
        resultBox.textContent = "âŒ ledger.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(err);
      }
    };

    // ğŸ“ å…¨ä½“ç…§åˆãƒ¢ãƒ¼ãƒ‰
    document.getElementById("globalVerify").onclick = async () => {
      resultBox.textContent = "å…¨ä½“ç…§åˆä¸­...";
      try {
        const ledger = await fetchLedger();
        const count = ledger.logs.length;
        resultBox.textContent = `âœ… ledger.json å…¨ä½“ã‚’èª­ã¿è¾¼ã¿å®Œäº†ï¼ˆ${count} ä»¶ã®è¨˜éŒ²ï¼‰`;
      } catch (err) {
        resultBox.textContent = "âŒ ledger.json ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(err);
      }
    };
  </script>
</body>
</html>
