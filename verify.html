<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger â€” Verify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #050710;
      color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.05em;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      opacity: 0.78;
    }
    main {
      padding: 16px 20px 32px;
    }
    section {
      margin-bottom: 20px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(5, 7, 16, 0.9);
      color: #f5f5f5;
      font-size: 13px;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #75bcff;
      box-shadow: 0 0 0 1px rgba(117, 188, 255, 0.5);
    }
    button {
      margin-top: 10px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #75bcff;
      color: #050710;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    .status-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(15, 20, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 12px;
      line-height: 1.7;
      white-space: pre-wrap;
      min-height: 60px;
    }
    .status-line {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .status-line span.icon {
      font-size: 14px;
      width: 1.2em;
      text-align: center;
    }
    .status-line span.text {
      flex: 1;
    }
    .status-ok {
      color: #9be28f;
    }
    .status-warn {
      color: #ffd166;
    }
    .status-error {
      color: #ff6b6b;
    }
    .summary-ok {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(23, 80, 43, 0.9);
      border: 1px solid rgba(155, 226, 143, 0.8);
      font-size: 12px;
    }
    .summary-warn {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(80, 65, 23, 0.9);
      border: 1px solid rgba(255, 209, 102, 0.9);
      font-size: 12px;
    }
    .summary-error {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(80, 29, 28, 0.9);
      border: 1px solid rgba(255, 107, 107, 0.9);
      font-size: 12px;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: rgba(255, 255, 255, 0.05);
      padding: 1px 4px;
      border-radius: 4px;
    }
    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 20px 18px;
      font-size: 11px;
      opacity: 0.6;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Sky Logger â€” Auto Verification</h1>
    <p class="subtitle">
      QRã‚³ãƒ¼ãƒ‰ã®URLãƒ»Firestore å…¬é–‹ãƒ­ã‚°ãƒ»GitHub ãƒãƒƒã‚·ãƒ¥ã® 3è€…ã‚’ç…§åˆã—ã¦ã€
      ã€Œãƒ­ã‚°ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚’æ¤œè¨¼ã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚
    </p>
  </div>
</header>

<main>
  <div class="wrap">
    <section>
      <label for="idInput">
        videoId / logId ï¼ˆé€šå¸¸ã¯QRã‚³ãƒ¼ãƒ‰ã®URLã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰
      </label>
      <input id="idInput" type="text"
             placeholder="ä¾‹: 8ea0a471-2870-4449-8ca1-baacb6e8624a" />
      <button id="runBtn">ã“ã® ID ã§æ¤œè¨¼ã‚’å®Ÿè¡Œã™ã‚‹</button>
      <p style="font-size:11px;opacity:.7;margin-top:6px;">
        URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>?videoId=...</code> ã¾ãŸã¯
        <code>?logId=...</code> ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€
        ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«è‡ªå‹•ã§æ¤œè¨¼ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
      </p>
    </section>

    <section>
      <div id="summary"></div>
      <div id="status" class="status-box">
        ã¾ã æ¤œè¨¼ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ Sky Logger ã‚·ã‚¹ãƒ†ãƒ ã®æ¤œè¨¼ç”¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
    <br />æ˜ åƒãã®ã‚‚ã®ã®çœŸå½ã§ã¯ãªãã€ã€Œãƒ­ã‚°è¨˜éŒ²ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã‹ã€ã‚’ç¢ºèªã—ã¾ã™ã€‚
  </div>
</footer>

<script>
  // ================================
  // ğŸ”§ è¨­å®š
  // ================================

  const FIREBASE_PROJECT_ID = "sky-logger-appv1";
  const FIRESTORE_API_KEY   = "AIzaSyA9mECKLUUpyaLsVLZJjq7KeZOEVzA";
  const COLLECTION_PATH     = "public_logs";

  // GitHub ãƒ«ãƒ¼ãƒˆï¼ˆgithubPath ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¾Œã‚ã«ä»˜ã‘ã‚‹ï¼‰
  const GITHUB_BASE_RAW =
    "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/";

  const statusEl  = document.getElementById("status");
  const summaryEl = document.getElementById("summary");
  const idInput   = document.getElementById("idInput");
  const runBtn    = document.getElementById("runBtn");

  function appendStatus(icon, text, cssClass) {
    const line = document.createElement("div");
    line.className = "status-line " + (cssClass || "");
    line.innerHTML =
      `<span class="icon">${icon}</span><span class="text">${text}</span>`;
    statusEl.appendChild(line);
  }

  function resetStatus(initialText) {
    statusEl.textContent = initialText || "";
  }

  function setSummary(type, text) {
    summaryEl.innerHTML = "";
    if (!text) return;
    const div = document.createElement("div");
    if (type === "ok") div.className = "summary-ok";
    else if (type === "warn") div.className = "summary-warn";
    else div.className = "summary-error";
    div.textContent = text;
    summaryEl.appendChild(div);
  }

  function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    const videoId = params.get("videoId");
    const logId   = params.get("logId");
    const hash    = params.get("hash");
    const createdAt = params.get("createdAt");
    return {
      videoId: videoId ? videoId.trim() : "",
      logId: logId ? logId.trim() : "",
      hash: hash ? hash.trim() : "",
      createdAt: createdAt ? createdAt.trim() : "",
    };
  }

  // ================================
  // Firestore ã‹ã‚‰1ä»¶å–å¾—
  // ================================
  async function fetchFirestoreDoc(id) {
    const url =
      `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}` +
      `/databases/(default)/documents/${COLLECTION_PATH}/${id}?key=${FIRESTORE_API_KEY}`;

    const res = await fetch(url);
    if (res.status === 404) {
      throw new Error("Firestore ã«è©²å½“ã™ã‚‹ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)");
    }
    if (!res.ok) {
      throw new Error("Firestore ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—: " + res.status);
    }
    return await res.json();
  }

  // Firestore â†’ å…¬é–‹ãƒ­ã‚°ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æŠ½å‡º
  function extractPublicLog(doc) {
    const f = doc.fields || {};

    const v = (x) =>
      x?.stringValue ??
      x?.integerValue ??
      x?.doubleValue ??
      x?.booleanValue ??
      x?.timestampValue ??
      null;

    return {
      id: v(f.id),
      videoId: v(f.videoId),
      hash: v(f.hash),
      githubPath: v(f.githubPath),
      githubCommit: v(f.githubCommit),
      createdAt: v(f.createdAt),
      githubUploadedAt: v(f.githubUploadedAt),
      verifyUrl: v(f.verifyUrl),
    };
  }

  // GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—ï¼ˆgithubPath ã‚’ä½¿ã†ï¼‰
  async function fetchGitHubHashByPath(path) {
    if (!path) {
      throw new Error("Firestore ã« githubPath ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    }
    const url = GITHUB_BASE_RAW + path;
    const res = await fetch(url);
    if (res.status === 404) {
      throw new Error("GitHub ã®ãƒãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)");
    }
    if (!res.ok) {
      throw new Error("GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—å¤±æ•—: " + res.status);
    }
    return (await res.text()).trim();
  }

  // ================================
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†
  // ================================
  async function runVerification(fromUrlParams) {
    const urlParams = fromUrlParams || getUrlParams();
    const effectiveId =
      idInput.value.trim() ||
      urlParams.videoId ||
      urlParams.logId;

    if (!effectiveId) {
      alert("videoId / logId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }

    idInput.value = effectiveId;
    setSummary("", "");
    resetStatus(`æ¤œè¨¼ä¸­...\nID: ${effectiveId}\n`);

    try {
      // 1. URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®çŠ¶æ³
      if (urlParams.videoId || urlParams.logId || urlParams.hash || urlParams.createdAt) {
        appendStatus(
          "ğŸ”",
          `URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æã—ã¾ã—ãŸ: ` +
            `videoId=${urlParams.videoId || "-"}, ` +
            `logId=${urlParams.logId || "-"}, ` +
            `hash=${urlParams.hash || "-"}, ` +
            `createdAt=${urlParams.createdAt || "-"}`,
          "status-ok"
        );
      } else {
        appendStatus(
          "â„¹ï¸",
          "URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ‰‹å…¥åŠ›ã«ã‚ˆã‚‹æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚",
          "status-warn"
        );
      }

      // 2. Firestore å–å¾—
      appendStatus("â³", "Firestore public_logs ã‚’å–å¾—ä¸­â€¦");
      const doc = await fetchFirestoreDoc(effectiveId);
      appendStatus("ğŸ“„", "Firestore ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—æˆåŠŸ", "status-ok");

      const log = extractPublicLog(doc);
      appendStatus(
        "ğŸ§©",
        `Firestore ãƒ­ã‚°æƒ…å ±:\n` +
          `  id: ${log.id}\n` +
          `  videoId: ${log.videoId}\n` +
          `  hash: ${log.hash}\n` +
          `  createdAt: ${log.createdAt}\n` +
          `  githubPath: ${log.githubPath}`,
        "status-ok"
      );

      // 3. URL vs Firestore ã®çªãåˆã‚ã›
      let urlIdOk = true;
      let urlHashOk = true;
      let urlCreatedAtOk = true;

      const urlId = urlParams.videoId || urlParams.logId || "";
      if (urlId) {
        urlIdOk = (urlId === log.id) && (urlId === log.videoId);
        appendStatus(
          urlIdOk ? "âœ…" : "âŒ",
          urlIdOk
            ? "URL ã® ID ã¨ Firestore(id / videoId) ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚"
            : "URL ã® ID ã¨ Firestore ã® id / videoId ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
          urlIdOk ? "status-ok" : "status-error"
        );
      }

      if (urlParams.hash) {
        urlHashOk = urlParams.hash === log.hash;
        appendStatus(
          urlHashOk ? "âœ…" : "âŒ",
          urlHashOk
            ? "URL ã® hash ã¨ Firestore ã® hash ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚"
            : "URL ã® hash ã¨ Firestore ã® hash ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
          urlHashOk ? "status-ok" : "status-error"
        );
      } else {
        appendStatus(
          "â„¹ï¸",
          "URL ã« hash ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆæ—§å½¢å¼ã¾ãŸã¯ç°¡ç•¥ãƒªãƒ³ã‚¯ï¼‰ã€‚",
          "status-warn"
        );
      }

      if (urlParams.createdAt) {
        urlCreatedAtOk = urlParams.createdAt === log.createdAt;
        appendStatus(
          urlCreatedAtOk ? "âœ…" : "âŒ",
          urlCreatedAtOk
            ? "URL ã® createdAt ã¨ Firestore ã® createdAt ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚"
            : "URL ã® createdAt ã¨ Firestore ã® createdAt ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
          urlCreatedAtOk ? "status-ok" : "status-error"
        );
      }

      // 4. GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—
      appendStatus("â³", "GitHub ãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—ä¸­â€¦");
      const githubHash = await fetchGitHubHashByPath(log.githubPath);
      appendStatus(
        "ğŸ”‘",
        `hash(GitHub): ${githubHash}`,
        "status-ok"
      );

      const fsVsGithubOk = log.hash === githubHash;
      appendStatus(
        fsVsGithubOk ? "âœ…" : "âŒ",
        fsVsGithubOk
          ? "Firestore ã® hash ã¨ GitHub ã®ãƒãƒƒã‚·ãƒ¥ãŒå®Œå…¨ä¸€è‡´ã—ã¾ã—ãŸã€‚"
          : "Firestore ã® hash ã¨ GitHub ã®ãƒãƒƒã‚·ãƒ¥ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
        fsVsGithubOk ? "status-ok" : "status-error"
      );

      // 5. æœ€çµ‚åˆ¤å®š
      const allOk =
        fsVsGithubOk &&
        (urlId ? urlIdOk : true) &&
        (urlParams.hash ? urlHashOk : true) &&
        (urlParams.createdAt ? urlCreatedAtOk : true);

      if (allOk) {
        setSummary(
          "ok",
          "âœ… ã“ã®ãƒ­ã‚°ã¯ Sky Logger ã®è¨˜éŒ²ã©ãŠã‚Šã§ã‚ã‚Šã€" +
            "Firestoreãƒ»GitHubãƒ»QRã‚³ãƒ¼ãƒ‰ URL ã®ã„ãšã‚Œã«ã‚‚æ”¹ã–ã‚“ã®ç—•è·¡ã¯è¦‹ã‚‰ã‚Œã¾ã›ã‚“ã€‚"
        );
      } else {
        setSummary(
          "error",
          "âš ï¸ ä¸€éƒ¨ã«ä¸ä¸€è‡´ãŒã‚ã‚Šã¾ã™ã€‚URLãƒ»Firestoreãƒ»GitHub ã®ã„ãšã‚Œã‹ãŒå¤‰æ›´ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚" +
            " è©³ç´°ã¯ä¸‹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¬„ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
        );
      }
    } catch (e) {
      appendStatus("âŒ", "ã‚¨ãƒ©ãƒ¼: " + e.message, "status-error");
      setSummary(
        "error",
        "æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°IDã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
      );
    }
  }

  runBtn.addEventListener("click", () => {
    resetStatus("");
    runVerification();
  });

  window.addEventListener("DOMContentLoaded", () => {
    const params = getUrlParams();
    const id = params.videoId || params.logId;
    if (id) {
      idInput.value = id;
      resetStatus("");
      runVerification(params);
    }
  });
</script>
</body>
</html>
