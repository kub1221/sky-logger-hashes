<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Sky Logger â€” Auto Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 0;
      background: #050710;
      color: #f5f5f5;
    }
    header {
      padding: 24px 20px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: radial-gradient(circle at top, #243b6b 0, #050710 45%);
    }
    .wrap {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.05em;
    }
    .subtitle {
      margin: 0;
      font-size: 13px;
      opacity: 0.78;
    }
    main {
      padding: 16px 20px 32px;
    }
    section {
      margin-bottom: 20px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    input[type="text"] {
      width: 100%;
      padding: 7px 9px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(5, 7, 16, 0.9);
      color: #f5f5f5;
      font-size: 13px;
    }
    button {
      margin-top: 10px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: #75bcff;
      color: #050710;
      font-weight: 600;
    }
    .status-box {
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 8px;
      background: rgba(15, 20, 40, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.08);
      font-size: 12px;
      line-height: 1.7;
      white-space: pre-wrap;
      min-height: 60px;
    }
    .status-line {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .status-ok { color: #9be28f; }
    .status-error { color: #ff6b6b; }
    .status-warn { color: #ffd166; }
    .summary-ok, .summary-error {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
    }
    .summary-ok {
      background: rgba(23, 80, 43, 0.9);
      border: 1px solid rgba(155, 226, 143, 0.8);
    }
    .summary-error {
      background: rgba(80, 29, 28, 0.9);
      border: 1px solid rgba(255, 107, 107, 0.9);
    }
    footer {
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      padding: 10px 20px 18px;
      font-size: 11px;
      opacity: 0.6;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Sky Logger â€” Auto Verification</h1>
    <p class="subtitle">
      QRã‚³ãƒ¼ãƒ‰ã®URLãƒ»Firestore å…¬é–‹ãƒ­ã‚°ãƒ»GitHub ãƒãƒƒã‚·ãƒ¥ã®3è€…ã‚’ç…§åˆã—ã¦ã€æ”¹ã–ã‚“ã®æœ‰ç„¡ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
    </p>
  </div>
</header>

<main>
  <div class="wrap">
    <section>
      <label for="idInput">videoId / logId</label>
      <input id="idInput" type="text" placeholder="ä¾‹: a25c8000-4a5a-4bbe-82cc-6f6ec65d9d0d" />
      <button id="runBtn">ã“ã®IDã§æ¤œè¨¼ã™ã‚‹</button>
    </section>

    <section>
      <div id="summary"></div>
      <div id="status" class="status-box">ã¾ã æ¤œè¨¼ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    </section>
  </div>
</main>

<footer>
  <div class="wrap">
    ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ Sky Logger ã®å…¬é–‹æ¤œè¨¼ãƒšãƒ¼ã‚¸ã§ã™ã€‚
    Firestore ã¨ GitHub ã®æ•´åˆæ€§ã‚’ç¬¬ä¸‰è€…ãŒç¢ºèªã§ãã¾ã™ã€‚
  </div>
</footer>

<script>
  const FIREBASE_PROJECT_ID = "sky-logger-appv1";
  const FIRESTORE_API_KEY   = "AIzaSyA9mECKLUUpyaLsVLZJjq7KeZOEVzA";
  const COLLECTION_PATH     = "public_logs";
  const GITHUB_BASE_RAW     =
    "https://raw.githubusercontent.com/kub1221/sky-logger-hashes/main/";

  const statusEl  = document.getElementById("status");
  const summaryEl = document.getElementById("summary");
  const idInput   = document.getElementById("idInput");

  function appendStatus(icon, text, cls) {
    const line = document.createElement("div");
    line.className = "status-line " + (cls || "");
    line.innerHTML = `<span>${icon}</span><span>${text}</span>`;
    statusEl.appendChild(line);
  }

  function resetStatus() {
    statusEl.innerHTML = "";
  }

  function setSummary(type, text) {
    summaryEl.innerHTML = "";
    const div = document.createElement("div");
    div.className = type === "ok" ? "summary-ok" : "summary-error";
    div.textContent = text;
    summaryEl.appendChild(div);
  }

  function getUrlParams() {
    const p = new URLSearchParams(window.location.search);
    return {
      videoId:  p.get("videoId")?.trim() || "",
      logId:    p.get("logId")?.trim() || "",
      hash:     p.get("hash")?.trim() || ""
    };
  }

  async function fetchFirestore(id) {
    const url =
      `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents/${COLLECTION_PATH}/${id}?key=${FIRESTORE_API_KEY}`;
    const res = await fetch(url);
    if (res.status === 404) throw new Error("Firestore: ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)");
    if (!res.ok) throw new Error("Firestore å–å¾—ã‚¨ãƒ©ãƒ¼: " + res.status);
    return await res.json();
  }

  function extract(doc) {
    const f = doc.fields;
    const v = (x) => x?.stringValue ?? x?.timestampValue ?? x?.integerValue ??
                     x?.doubleValue ?? x?.booleanValue ?? null;
    return {
      id:           v(f.id),
      videoId:      v(f.videoId),
      hash:         v(f.hash),
      githubPath:   v(f.githubPath)
    };
  }

  async function fetchGithubHash(path) {
    const url = GITHUB_BASE_RAW + path;
    const res = await fetch(url);
    if (!res.ok) throw new Error("GitHub å–å¾—ã‚¨ãƒ©ãƒ¼: " + res.status);
    return (await res.text()).trim();
  }

  async function runVerification() {
    resetStatus();
    summaryEl.innerHTML = "";

    const params = getUrlParams();
    const id = idInput.value.trim() || params.videoId || params.logId;

    if (!id) {
      alert("videoId / logId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    idInput.value = id;

    appendStatus("â³", "Firestore ã‚’å–å¾—ä¸­â€¦");

    try {
      const doc = await fetchFirestore(id);
      const log = extract(doc);

      appendStatus("ğŸ“„", `Firestore å–å¾—æˆåŠŸï¼ˆid=${log.id}ï¼‰`, "status-ok");

      // URL ã® ID ä¸€è‡´
      if (params.videoId || params.logId) {
        const urlId = params.videoId || params.logId;
        const idOk = (urlId === log.id) && (urlId === log.videoId);
        appendStatus(idOk ? "âœ…" : "âŒ",
          idOk ? "URL ã® ID ã¨ Firestore ã® id ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚" :
                 "URL ã® ID ã¨ Firestore ã® id ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
          idOk ? "status-ok" : "status-error"
        );
      }

      // URL ã® hash ã¨ä¸€è‡´ï¼Ÿ
      if (params.hash) {
        const hOk = (params.hash === log.hash);
        appendStatus(hOk ? "âœ…" : "âŒ",
          hOk ? "URL ã® hash ã¨ Firestore ã® hash ãŒä¸€è‡´ã—ã¾ã—ãŸã€‚" :
                "URL ã® hash ã¨ Firestore ã® hash ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
          hOk ? "status-ok" : "status-error"
        );
      }

      appendStatus("â³", "GitHub ãƒãƒƒã‚·ãƒ¥å–å¾—ä¸­â€¦");

      const gh = await fetchGithubHash(log.githubPath);
      const fsVsGh = (log.hash === gh);

      appendStatus(
        fsVsGh ? "ğŸ”‘" : "âŒ",
        fsVsGh ? "Firestore ã¨ GitHub ã®ãƒãƒƒã‚·ãƒ¥ãŒå®Œå…¨ä¸€è‡´ã—ã¾ã—ãŸã€‚" :
                 "Firestore ã¨ GitHub ã®ãƒãƒƒã‚·ãƒ¥ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
        fsVsGh ? "status-ok" : "status-error"
      );

      if (fsVsGh) {
        setSummary("ok", "ã“ã®ãƒ­ã‚°ã¯æ”¹ã–ã‚“ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ã€‚");
      } else {
        setSummary("error", "æ”¹ã–ã‚“ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }

    } catch (e) {
      appendStatus("âŒ", e.message, "status-error");
      setSummary("error", "æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }
  }

  document.getElementById("runBtn").onclick = runVerification;

  window.addEventListener("DOMContentLoaded", () => {
    const p = getUrlParams();
    const idParam = p.videoId || p.logId;
    if (idParam) {
      idInput.value = idParam;
      runVerification();
    }
  });
</script>

</body>
</html>
